<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>jubianchi.fr</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Julien Bianchi <contact@jubianchi.fr>">

    <link href="data:image/x-icon;base64,AAABAAEAEBAQAAAAAAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAenp6AO6//wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABERERERAAABEQAAAAEQABIhARARASIAEiERERERIgAREAERAQARABETARERMBEAEREREREREQABEREREREQAAEREAABERAAAREAAAABEAABEAAAAAEQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//wAA4AcAAMADAACAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAQAAgAEAAIPBAACH4QAAz/MAAP//AAD//wAA" rel="icon" type="image/x-icon" />

    <link href='http://fonts.googleapis.com/css?family=Exo+2:400,100,200,300' rel='stylesheet' type='text/css'>
    <link href="styles/ui.css" rel="stylesheet">

    <link href="js/prismjs/prism.css" rel="stylesheet" />
    <link href="js/prismjs/prism-okaidia.css" rel="stylesheet" />
    <link href="js/prismjs/plugins/line-numbers/prism-line-numbers.css" rel="stylesheet" />
    <link href="styles/github.css" rel="stylesheet" />

    <script src="js/jquery.js"></script>
</head>

<body>

<header>
    <a href="index.htm"><img class="avatar" src="images/nyantocat.gif"/></a>

    <h1>Julien Bianchi <small><em>aka jubianchi</em></small></h1>

    <ul>
        <li><a href="mailto:contact@jubianchi.fr" title="email">email</a></li>
        <li><a href="https://twitter.com/jubianchi" title="twitter">twitter</a></li>
        <li><a href="https://github.com/jubianchi" title="github">github</a></li>
        <li><a href="https://speakerdeck.com/jubianchi" title="speakerdeck">speakerdeck</a></li>
        <li><a href="https://coderwall.com/jubianchi" title="coderwall">coderwall</a></li>
        <li><a href="http://osrc.dfm.io/jubianchi" title="Open Source Report Card">OSRC</a></li>
        <li><a href="cv/index.html" title="jubianchi.fr">CV</a></li>
    </ul>
</header>
    <article>
            <time>
        <strong>&nbsp;</strong>
        <span>Draft</span>
    </time>

        <header>
            <h1>atoum feature preview #2 : mock pleaz</h1>
        </header>

        <div class="content">
            <p>Cet article est le premier d'une série qui va vous présenter les fonctionnalités à venir dans atoum.
Ces fonctionnalités ne sont actuellement pas disponible sur le <code>master</code> d'atoum mais vous pouvez les
tester en utilisant la branche <code>edge</code> :</p>

<pre class="line-numbers"><code class="language-javascript">{
    "require-dev": {
        "atoum/atoum": "dev-edge"
    }
}</code></pre>

<p>Dans cette article, nous allons découvrir plusieurs nouveatés autour des <em>mock</em> dans atoum. L'API des mocks,
autant au niveau des controlleurs que des assertions, s'est vue dotée de plusieurs nouvelles petites fonctions
qui vont vous permettre d'écrire des test encore plus clairs, plus facilement.</p>

<p>Commençons par voir comment créer et configurer un mock classique :</p>

<pre class="line-numbers"><code class="language-php">namespace jubianchi\atoum\preview\tests\units;

use atoum;
use jubianchi\atoum\preview\foo as testedClass;

class foo extends atoum
{
    public function testBar()
    {
        $this
            ->if(
                $foo = new \mock\jubianchi\atoum\preview\foo(),
                $this->calling($foo)->bar = $foo,
                $this->calling($foo)->baz = null
            )
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->variable($foo->baz())->isNull($foo)

            ->if(
                $foo = new \mock\jubianchi\atoum\preview\foo(),
                $this->calling($foo)->bar = $foo
            )
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->string($foo->baz())->isEqualTo('baz')
        ;
    }
}</code></pre>

<p>Dans cette exemple, nous avons deux cas de test : le premier, dans lequel nous avons redéfini 2 méthodes du mock
et le second, dans lequel nous redéfinissons unqiuement 1 méthode du mock. Ce test peut être amélioré pour être plus
clair, et atoum nous propose les solutions suivantes :</p>

<pre class="line-numbers"><code class="language-php">namespace jubianchi\atoum\preview\tests\units;

use atoum;
use jubianchi\atoum\preview\foo as testedClass;

class foo extends atoum
{
    public function testBar()
    {
        $this
            ->if(
                $foo = new \mock\jubianchi\atoum\preview\foo(),
                $this->calling($foo)->bar->isFluent,
                $this->calling($foo)->baz->doesNothing
            )
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->variable($foo->baz())->isNull($foo)

            ->if($this->calling($foo)->baz->doesSomething)
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->string($foo->baz())->isEqualTo('baz')
        ;
    }
}</code></pre>

<p>Qu'est-ce que nous avons donc :</p>

<ul>
<li><code>$this->calling($foo)->bar->isFluent</code> (ligne 13) permet, comme son nom l'indique, de rendre la méthode
fluide (elle retourne l'instance de l'objet par lequel elle est appelée). La méthode <code>isFluent</code> est un alias
do <code>returnThis</code>, vous pouvez donc également utiliser <code>$this->calling($foo)->bar->returnThis</code>.</li>
<li><code>$this->calling($foo)->baz->doesNothing</code> (ligne 14) permet de rendre une méthode inopérante, elle
retournera donc <code>null</code>. Vous pouvez donc facilement désactiver une méthode.</li>
<li><code>$this->calling($foo)->baz->doesSomething</code> permet de restaurer le comportement original de la méthode.
L'utilisation de cette méthode a permit de supprimer un peu de code dans l'exemple précédent : en effet, on n'a plus besoin
de recréer une instance du mock pour restaurer ses méthodes.</li>
</ul>

<p>Passons maintenant aux assertions. Voyons tout de suite un exemple (encore) :</p>

<pre class="line-numbers"><code class="language-php">namespace jubianchi\atoum\preview\tests\units;

use atoum;
use jubianchi\atoum\preview\foo as testedClass;

class foo extends atoum
{
    public function testBar()
    {
        $this
            ->if($foo = new \mock\jubianchi\atoum\preview\foo())
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->mock($foo)
                    ->call('boo')->once()
                    ->call('baz')->exactly(4)
        ;
    }
}</code></pre>

<p>Il n'y a pas grand chose dans ce test, mais ce n'est pas pour ça qu'il n'y a rien à proposer en terme de
sucre syntaxique :</p>

<pre class="line-numbers"><code class="language-php">namespace jubianchi\atoum\preview\tests\units;

use atoum;
use jubianchi\atoum\preview\foo as testedClass;

class foo extends atoum
{
    public function testBar()
    {
        $this
            ->if($foo = new \mock\jubianchi\atoum\preview\foo())
            ->then
                ->object($foo->bar())->isIdenticalTo($foo)
                ->mock($foo)
                    ->call('boo')->once
                    ->call('baz')->{4}
        ;
    }
}</code></pre>

<p>Comme vous le voyez, les paranthèses de <code>once</code> sont devenue optionnelles et il en va de même pour ses
soeurs, <code>twice</code> et <code>thrice</code>.</p>

<p>Nous avons également introduit une nouvelles petites syntaxe dans atoum pour remplace les appels à <code>exactly</code> :
vous pouvez maitenant utiliser <code>->{n}</code> (où <code>n</code> est un entier).</p>

<p>N'oubliez pas que vous pouvez tester tout cela en utilisant la branche <code>edge</code> d'atoum. La <em>pull-request</em>
contenant le code est disponible <a href="https://github.com/atoum/atoum/pull/320">ici</a> : n'hésitez pas à ajoutez vos commentaires.</p>

        </div>

        <footer>
                <ul class="inline">
        <li class="legend">Publié dans :</li>
                    <li>php</li>
                    <li>atoum</li>
                    <li>test</li>
            </ul>
        </footer>
    </article>

    
<hr/>

<footer>&bull;&bull;&bull;</footer>

<script src="js/prismjs/prism.js"></script>
<script src="js/prismjs/components/prism-bash.js"></script>
<script src="js/prismjs/components/prism-php.js"></script>
<script src="js/prismjs/components/prism-php-extras.js"></script>
<script src="js/prismjs/components/prism-css.js"></script>
<script src="js/prismjs/plugins/line-numbers/prism-line-numbers.js"></script>
<script src="js/jquery.github.js"></script>
<script>$(function() { $("[data-repo]").github(); });</script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-10349389-8', 'jubianchi.fr');
    ga('send', 'pageview');

</script>
</body>
</html>
